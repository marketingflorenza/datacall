<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer Insights & Retention)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --accent: #3498db;
      --warning: #f39c12;
      --danger: #e74c3c;
      --bg: #f5f7fa;
      --text: #2d3436;
      --white: #ffffff;
    }

    body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
    
    .container { 
      max-width: 1400px; margin: 0 auto; background: var(--white); 
      padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
    }

    h2 { text-align: center; margin-bottom: 30px; color: var(--secondary); font-weight: 600; font-size: 2em; }

    .upload-section { 
      background: #f8f9fa; border: 2px dashed #cbd5e0; 
      padding: 40px; border-radius: 12px; text-align: center; margin-bottom: 30px;
      transition: all 0.3s;
    }
    .upload-section:hover { border-color: var(--primary); background: #f0f4ff; }
    input[type="file"] { cursor: pointer; font-size: 1rem; }

    .controls { 
      display: flex; flex-wrap: wrap; gap: 15px; align-items: center; 
      background: #fff; padding: 20px; border-radius: 12px; 
      border: 1px solid #e2e8f0; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .input-group { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 0.95rem; }
    .controls input, .controls select { 
      padding: 10px 14px; border: 1px solid #cbd5e0; border-radius: 8px; outline: none; transition: 0.2s; font-family: inherit;
    }
    .controls input[type="text"] { width: 180px; }
    .controls input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    
    .retention-panel {
      background: #fff5f5; border: 1px solid #fed7d7; padding: 15px; border-radius: 12px;
      display: flex; align-items: center; gap: 15px; margin-bottom: 20px;
    }
    .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius: 34px;
    }
    .slider:before {
      position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--danger); }
    input:checked + .slider:before { transform: translateX(20px); }

    button { 
      padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; 
      font-weight: 600; transition: all 0.2s; font-family: inherit; display: flex; align-items: center; gap: 6px;
    }
    #filterBtn { background: var(--accent); color: white; }
    #filterBtn:hover { background: #2980b9; transform: translateY(-1px); }
    #clearFilterBtn { background: #e2e8f0; color: #4a5568; }
    #exportBtn { background: #10b981; color: white; margin-left: auto; }

    .summary-section { 
      display: none; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; 
    }
    .summary-card { 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
      color: white; padding: 20px; border-radius: 12px; 
      text-align: center; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.2); 
    }
    .summary-card.alert { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .summary-card h3 { margin: 0 0 10px; font-size: 1rem; opacity: 0.9; font-weight: 400; }
    .summary-card .value { font-size: 2rem; font-weight: 700; margin: 0; }

    .table-container { 
      display: none; overflow-x: auto; border-radius: 12px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
    }
    table { width: 100%; border-collapse: collapse; background: white; min-width: 1000px; }
    th, td { padding: 14px 18px; border-bottom: 1px solid #edf2f7; text-align: left; vertical-align: middle; font-size: 0.95rem; }
    th { 
      background: #f8fafc; color: #4a5568; font-weight: 700; text-transform: uppercase; 
      font-size: 0.85rem; letter-spacing: 0.5px; position: sticky; top: 0; cursor: pointer; 
    }
    th:hover { background: #edf2f7; }
    tr:hover { background-color: #f7fafc; }
    
    .col-number { font-variant-numeric: tabular-nums; text-align: right; }
    .col-phone { font-family: 'Courier New', monospace; color: var(--accent); font-weight: 600; }
    .col-date { color: #805ad5; font-size: 0.9rem; }
    .status-badge { 
        padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; display: inline-block;
    }
    .status-overdue { background: #fff5f5; color: #e53e3e; border: 1px solid #feb2b2; }

    .loader-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.8); z-index: 999; justify-content: center; align-items: center; flex-direction: column;
    }
    .spinner {
      width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--secondary);
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    th.sort-asc::after { content: ' ‚ñ≤'; font-size: 0.8em; }
    th.sort-desc::after { content: ' ‚ñº'; font-size: 0.8em; }
  </style>
</head>
<body>

  <div id="loading" class="loader-overlay">
    <div class="spinner"></div>
    <div style="font-weight: 600; color: #555;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <div class="container">
    <h2>üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
    
    <div class="upload-section">
      <input type="file" id="fileInput" accept=".xlsx" />
      <p style="margin-top: 10px; color: #718096; font-size: 0.9rem;">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx) ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
    </div>

    <div class="retention-panel">
        <div style="display: flex; align-items: center; gap: 10px;">
            <label class="switch">
                <input type="checkbox" id="retentionToggle">
                <span class="slider"></span>
            </label>
            <span style="font-weight: 600; color: var(--danger);">‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (Retention)</span>
        </div>
        <div class="input-group">
            <label>‡∏´‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤:</label>
            <select id="retentionMonths">
                <option value="1">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="2">2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="3">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="4">4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="5">5 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="6" selected>6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="7">7 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="8">8 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="9">9 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="10">10 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="11">11 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="12">12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (1 ‡∏õ‡∏µ)</option>
            </select>
        </div>
        <div style="font-size: 0.85rem; color: #666; max-width: 400px;">
            * ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà <b>‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏</b> ‡πÅ‡∏ï‡πà <b>‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥</b> ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        </div>
    </div>

    <div class="controls">
      <div class="input-group">
        <label>üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label> <input type="date" id="fromDate" />
      </div>
      <div class="input-group">
        <label>‡∏ñ‡∏∂‡∏á:</label> <input type="date" id="toDate" />
      </div>

      <div class="input-group">
        <input type="text" id="itemSpecificInput" placeholder="üíä ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô Botox)..." />
      </div>
      
      <div class="input-group" style="flex-grow: 1;">
        <input type="text" id="globalSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, HN..." style="width: 100%;" />
      </div>

      <button id="filterBtn">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
      <button id="clearFilterBtn">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
      <button id="exportBtn">üì• Export Excel</button>
    </div>

    <div id="summarySection" class="summary-section">
      <div class="summary-card" id="cardTotal"><h3>üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3><p class="value" id="totalCustomers">-</p></div>
      <div class="summary-card"><h3>üõí ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</h3><p class="value" id="totalPurchases">-</p></div>
      <div class="summary-card"><h3>üìû ‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</h3><p class="value" id="customersWithPhone">-</p></div>
      <div class="summary-card"><h3>üí∞ ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏ß‡∏°</h3><p class="value" id="grandTotalPayment">-</p></div>
    </div>

    <div class="table-container" id="tableContainer">
      <table id="resultTable">
        <thead>
          <tr>
            <th style="width: 50px;">#</th>
            <th data-key="hn">HN</th>
            <th data-key="name">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
            <th data-key="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
            <th data-key="items">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
            <th id="thLastDate" data-key="lastDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
            <th data-key="diffMonths" class="col-number">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ô‡∏≤‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</th>
            <th data-key="totalPayment" class="col-number">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏ß‡∏°</th>
            <th data-key="visitCount" class="col-number">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let rawRowsGlobal = []; 
    let colMapping = {};    
    let processedData = []; 

    const els = {
      fileInput: document.getElementById('fileInput'),
      filterBtn: document.getElementById('filterBtn'),
      clearBtn: document.getElementById('clearFilterBtn'),
      exportBtn: document.getElementById('exportBtn'),
      globalSearch: document.getElementById('globalSearch'),
      itemSpecificInput: document.getElementById('itemSpecificInput'),
      retentionToggle: document.getElementById('retentionToggle'),
      retentionMonths: document.getElementById('retentionMonths'),
      fromDate: document.getElementById('fromDate'),
      toDate: document.getElementById('toDate'),
      loading: document.getElementById('loading'),
      summary: document.getElementById('summarySection'),
      tableCont: document.getElementById('tableContainer'),
      tbody: document.querySelector('#resultTable tbody'),
      cardTotal: document.getElementById('cardTotal'),
      thLastDate: document.getElementById('thLastDate')
    };

    els.fileInput.addEventListener('change', handleFile);
    els.filterBtn.addEventListener('click', () => runAggregation());
    els.clearBtn.addEventListener('click', clearFilters);
    els.exportBtn.addEventListener('click', exportToExcel);

    const toggleLoader = (show) => els.loading.style.display = show ? 'flex' : 'none';

    function parseExcelDate(dr) {
      if (!dr) return null;
      if (dr instanceof Date) {
          let d = new Date(dr);
          if (d.getFullYear() > 2400) d.setFullYear(d.getFullYear() - 543);
          return d;
      }
      const str = dr.toString().trim();
      const parts = str.split('/');
      if (parts.length === 3) {
          let year = parseInt(parts[2]);
          let month = parseInt(parts[1]) - 1;
          let day = parseInt(parts[0]);
          if (year > 2400) year -= 543;
          else if (year < 100) year += 2000;
          return new Date(year, month, day);
      }
      let d = new Date(str);
      if (d && !isNaN(d) && d.getFullYear() > 2400) d.setFullYear(d.getFullYear() - 543);
      return d;
    }

    function formatAD(date) {
      if (!date || isNaN(date)) return '-';
      return new Date(date).toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    const formatNum = (n) => n.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function normalizePhoneNumber(p) {
      if (!p) return '';
      let n = String(p).replace(/\D/g,'');
      if (n.startsWith('66')) n = '0' + n.slice(2);
      return n.length >= 9 ? n : '';
    }

    function handleFile(e) {
      const file = e.target.files[0]; if (!file) return;
      toggleLoader(true);
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array', cellDates: true });
          const ws = wb.Sheets[wb.SheetNames[0]];
          rawRowsGlobal = XLSX.utils.sheet_to_json(ws, { raw: true, defval: '' });
          identifyColumns(rawRowsGlobal);
          runAggregation();
        } catch (err) {
          alert('Error: ' + err.message);
        } finally {
          toggleLoader(false);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function identifyColumns(rows) {
      if (!rows.length) return;
      const headers = Object.keys(rows[0]).map(h => h.trim());
      const findKey = names => headers.find(h => names.some(n => h.toLowerCase().includes(n)));
      colMapping = {
        hn: findKey(['hn','id','‡∏£‡∏´‡∏±‡∏™']),
        name: findKey(['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•','‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•','‡∏ä‡∏∑‡πà‡∏≠','‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤']),
        phone: findKey(['‡πÇ‡∏ó‡∏£','phone','‡πÄ‡∏ö‡∏≠‡∏£‡πå']),
        items: findKey(['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','menu','item']),
        date: findKey(['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','date','‡∏ß‡∏±‡∏ô','‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î']),
        payment: findKey(['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°','‡∏£‡∏≤‡∏Ñ‡∏≤','price','total','amount']) 
      };
    }

    function runAggregation() {
      if (!rawRowsGlobal.length) return;
      toggleLoader(true);

      setTimeout(() => {
        const C = colMapping;
        const isRetentionMode = els.retentionToggle.checked;
        const retentionMonths = parseInt(els.retentionMonths.value);
        const targetItem = els.itemSpecificInput.value.trim().toLowerCase();
        
        const fromDate = els.fromDate.value ? new Date(els.fromDate.value) : null;
        const toDate = els.toDate.value ? new Date(els.toDate.value) : null;
        
        const now = new Date();
        const cutoffDate = new Date();
        cutoffDate.setMonth(now.getMonth() - retentionMonths);

        const map = {};

        rawRowsGlobal.forEach(r => {
          const id = (r[C.hn] || '').toString().trim();
          if (!id) return;

          const date = parseExcelDate(r[C.date]);
          const itemName = (r[C.items] || '').toString();
          const itemMatched = targetItem ? itemName.toLowerCase().includes(targetItem) : true;

          if (!map[id]) {
            map[id] = { 
              name: r[C.name] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠', 
              phone: '', 
              items: [], 
              allDates: [],
              targetItemDates: [], 
              totalPayment: 0 
            };
          }
          const o = map[id];

          const ph = normalizePhoneNumber(r[C.phone]);
          if (ph && !o.phone) o.phone = ph;

          if (date && !isNaN(date)) {
            o.allDates.push(date);
            if (itemMatched && targetItem) {
              o.targetItemDates.push(date);
            }
          }
          
          let passNormalFilter = true;
          if (fromDate && date < fromDate) passNormalFilter = false;
          if (toDate && date > toDate) passNormalFilter = false;
          if (targetItem && !itemMatched) passNormalFilter = false;

          if (passNormalFilter) {
            if (itemName.trim()) o.items.push(itemName.trim());
            const rawPay = String(r[C.payment] || '0').replace(/,/g, '');
            const payVal = parseFloat(rawPay);
            if (!isNaN(payVal)) o.totalPayment += payVal;
          }
        });

        let arr = Object.entries(map).map(([hn, o]) => {
          const lastDate = o.allDates.length ? new Date(Math.max(...o.allDates)) : null;
          const lastTargetDate = o.targetItemDates.length ? new Date(Math.max(...o.targetItemDates)) : null;
          
          const relevantDate = isRetentionMode ? lastTargetDate : lastDate;
          const diffMonths = getMonthsDiff(relevantDate, now);

          return {
            hn,
            name: o.name,
            phone: o.phone,
            items: [...new Set(o.items)].join(', '),
            lastDate,
            lastTargetDate,
            diffMonths: diffMonths,
            visitCount: o.items.length,
            totalPayment: o.totalPayment,
            hasTargetHistory: o.targetItemDates.length > 0
          };
        });

        if (isRetentionMode) {
          if (!targetItem) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Retention");
            els.retentionToggle.checked = false;
          } else {
            arr = arr.filter(r => r.hasTargetHistory && r.lastTargetDate < cutoffDate);
          }
        } else {
          arr = arr.filter(r => r.visitCount > 0);
        }

        const kw = els.globalSearch.value.trim().toLowerCase();
        if (kw) {
          arr = arr.filter(r => r.name.toLowerCase().includes(kw) || r.hn.toLowerCase().includes(kw));
        }

        arr.sort((a,b) => {
            const dateA = isRetentionMode ? a.lastTargetDate : a.lastDate;
            const dateB = isRetentionMode ? b.lastTargetDate : b.lastDate;
            return (dateB || 0) - (dateA || 0);
        });

        processedData = arr;
        updateUI();
        toggleLoader(false);
      }, 50);
    }

    function updateUI() {
      els.summary.style.display = 'grid';
      els.tableCont.style.display = 'block';

      const isRetention = els.retentionToggle.checked;
      const targetItem = els.itemSpecificInput.value || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ';
      
      els.cardTotal.className = isRetention ? 'summary-card alert' : 'summary-card';
      els.cardTotal.querySelector('h3').textContent = isRetention ? `üë• ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (${targetItem})` : 'üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
      els.thLastDate.textContent = isRetention ? `‡∏ã‡∏∑‡πâ‡∏≠ ${targetItem} ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î` : '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';

      document.getElementById('totalCustomers').textContent = processedData.length.toLocaleString();
      document.getElementById('totalPurchases').textContent = processedData.reduce((s, r) => s + r.visitCount, 0).toLocaleString();
      document.getElementById('customersWithPhone').textContent = processedData.filter(r => r.phone).length.toLocaleString();
      document.getElementById('grandTotalPayment').textContent = formatNum(processedData.reduce((s, r) => s + r.totalPayment, 0));

      renderTable(processedData);
    }

    function renderTable(arr) {
      els.tbody.innerHTML = '';
      const isRetention = els.retentionToggle.checked;

      arr.forEach((r, i) => {
        const tr = document.createElement('tr');
        const displayDate = isRetention ? r.lastTargetDate : r.lastDate;

        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${r.hn}</td>
          <td>${r.name}</td>
          <td class="col-phone">${r.phone || '-'}</td>
          <td title="${r.items}">${truncate(r.items, 50)}</td>
          <td class="col-date">${formatAD(displayDate)}</td>
          <td class="col-number">
            ${r.diffMonths > 0 ? `<span class="status-badge ${isRetention ? 'status-overdue' : ''}">${r.diffMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>` : '0'}
          </td>
          <td class="col-number">${formatNum(r.totalPayment)}</td>
          <td class="col-number">${r.visitCount}</td>
        `;
        els.tbody.appendChild(tr);
      });
      enableSorting();
    }

    function getMonthsDiff(d1, d2) {
        if (!d1 || !d2 || isNaN(d1.getTime()) || isNaN(d2.getTime())) return 0;
        let months = (d2.getFullYear() - d1.getFullYear()) * 12;
        months -= d1.getMonth();
        months += d2.getMonth();
        return months <= 0 ? 0 : months;
    }

    function truncate(str, n) { return (str.length > n) ? str.substr(0, n-1) + '...' : str; }

    function clearFilters() {
      els.fromDate.value = '';
      els.toDate.value = '';
      els.globalSearch.value = '';
      els.itemSpecificInput.value = '';
      els.retentionToggle.checked = false;
      runAggregation();
    }

    function enableSorting() {
      document.querySelectorAll('#resultTable th[data-key]').forEach(th => {
        const newTh = th.cloneNode(true);
        th.parentNode.replaceChild(newTh, th);
        newTh.onclick = () => {
          const key = newTh.dataset.key;
          const asc = !newTh.classList.contains('sort-asc');
          document.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc','sort-desc'));
          newTh.classList.add(asc ? 'sort-asc' : 'sort-desc');

          processedData.sort((a,b) => {
            let valA = a[key], valB = b[key];
            if (key === 'lastDate') { 
                const isRetention = els.retentionToggle.checked;
                valA = isRetention ? (a.lastTargetDate || 0) : (a.lastDate || 0); 
                valB = isRetention ? (b.lastTargetDate || 0) : (b.lastDate || 0); 
            }
            if (['totalPayment','visitCount','diffMonths'].includes(key)) return asc ? valA - valB : valB - valA;
            return asc ? String(valA).localeCompare(String(valB), 'th') : String(valB).localeCompare(String(valA), 'th');
          });
          renderTable(processedData);
        };
      });
    }

    function exportToExcel() {
      if (!processedData.length) return;
      const isRetention = els.retentionToggle.checked;
      const exportData = processedData.map((r, i) => ({
        '‡∏•‡∏≥‡∏î‡∏±‡∏ö': i + 1,
        'HN': r.hn,
        '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤': r.name,
        '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå': r.phone,
        '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠': r.items,
        [isRetention ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î']: formatAD(isRetention ? r.lastTargetDate : r.lastDate),
        '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ô‡∏≤‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)': r.diffMonths,
        '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°': r.totalPayment,
        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠': r.visitCount
      }));
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Data');
      XLSX.writeFile(wb, `Customer_Insights_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
  </script>
</body>
</html>
